trigger:
- main

pool:
  vmImage: 'ubuntu-latest'

variables:
  FRONT_URL: 'http://localhost:4200'
  API_URL: 'http://localhost:8080'

stages:
- stage: Setup
  displayName: 'Setup Environment'
  jobs:
  - job: Install
    displayName: 'Install Dependencies'
    steps:
    - task: NodeTool@0
      inputs:
        versionSpec: '20.x'
      displayName: 'Use Node.js 20.x'

    - script: |
        npm install --legacy-peer-deps
      displayName: 'Install npm dependencies'

    - script: |
        npx playwright install
      displayName: 'Install Playwright Browsers'

- stage: ServeBackend
  displayName: 'Run Backend API'
  jobs:
  - job: Backend
    displayName: 'Start API'
    steps:
    - script: |
        # Ejecuta tu backend en segundo plano
        nohup npm run start:api &
      displayName: 'Start Backend API'

- stage: ServeFrontend
  displayName: 'Run Angular Frontend'
  dependsOn: ServeBackend
  jobs:
  - job: Frontend
    displayName: 'Start Angular App'
    steps:
    - script: |
        nohup npx ng serve --port 4200 &
        # Esperar a que el frontend est√© listo
        sleep 15
      displayName: 'Start Angular Frontend'

- stage: RunPlaywrightTests
  displayName: 'Run Playwright Tests'
  dependsOn: ServeFrontend
  jobs:
  - job: Playwright
    displayName: 'Execute Playwright Tests'
    steps:
    - script: |
        npx playwright test ./playwright/tests --reporter=list
      displayName: 'Run Playwright Front + API Tests'
